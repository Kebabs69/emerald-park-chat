<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Civility Chat | Elite Networking</title>
    <style>
        :root { 
            --p-green: #1B3022; 
            --a-gold: #D4AF37; 
            --bg: #f8f9fa; 
            --white: #ffffff;
            --admin-red: #e74c3c; 
            --vip-blue: #3498db; 
            --coffee-orange: #FFDD00; 
            --glass: rgba(255, 255, 255, 0.95);
        }
        
        body { font-family: 'Inter', 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; color: #333; }

        /* PROFESSIONAL AUTH SCREEN */
        #auth-screen { 
            background: linear-gradient(135deg, var(--p-green) 0%, #2c4a35 100%);
            height: 100vh; display: flex; align-items: center; justify-content: center;
        }
        .auth-card { 
            background: var(--glass); padding: 40px; border-radius: 24px; width: 360px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.4); text-align: center; border: 1px solid rgba(255,255,255,0.2);
        }
        .auth-logo-img { width: 120px; height: auto; margin-bottom: 20px; }
        .auth-card h2 { color: var(--p-green); margin-bottom: 5px; font-weight: 800; }
        .auth-card p { color: #666; font-size: 14px; margin-bottom: 25px; }

        /* TOP NAVIGATION BAR */
        .top-nav {
            background: var(--p-green); color: white; padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 3px solid var(--a-gold); z-index: 100;
        }
        .user-status-strip { display: flex; align-items: center; gap: 15px; }
        .mini-avatar { width: 35px; height: 35px; border-radius: 50%; border: 2px solid var(--a-gold); object-fit: cover; background: #eee; }

        /* ROOMS BAR */
        .rooms-bar { background: #264230; padding: 12px; display: flex; gap: 12px; overflow-x: auto; scrollbar-width: none; }
        .room-btn { 
            background: rgba(255,255,255,0.1); border: none; color: white; 
            padding: 8px 20px; border-radius: 30px; cursor: pointer; transition: 0.3s; white-space: nowrap; font-size: 13px;
        }
        .room-btn.active { background: var(--a-gold); color: var(--p-green); font-weight: bold; }

        /* MAIN LAYOUT */
        #main-container { display: flex; flex: 1; overflow: hidden; }
        
        #chat-section { flex: 1; display: flex; flex-direction: column; background: var(--bg); }
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        /* SIDEBAR (ONLY ONLINE LIST & SUPPORT) */
        #profile-sidebar { width: 240px; background: var(--white); border-left: 1px solid #eee; display: flex; flex-direction: column; padding: 20px; }
        .online-tag { background: #e8f5e9; color: #2ecc71; padding: 5px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; text-align: center; margin-bottom: 15px; }

        .message { background: white; padding: 14px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); max-width: 80%; line-height: 1.5; }
        .msg-header { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; color: #777; }
        
        .chat-input-area { padding: 20px; background: white; border-top: 1px solid #eee; display: flex; gap: 12px; align-items: center; }
        .chat-input-area input { flex: 1; padding: 14px; border-radius: 30px; border: 1px solid #ddd; outline: none; }

        /* ADMIN PANEL AT BOTTOM */
        #admin-panel { background: #fff5f5; border-top: 2px solid var(--admin-red); padding: 15px; display: none; gap: 10px; flex-wrap: wrap; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-card" id="login-form">
            <img src="public/logo.png" class="auth-logo-img">
            <h2>Elite Networking</h2>
            <p>Welcome back to the executive lounge.</p>
            <input type="email" id="l-email" placeholder="Professional Email" style="width:100%; padding:12px; margin-bottom:15px; border-radius:8px; border:1px solid #ddd;">
            <input type="password" id="l-pass" placeholder="Password" style="width:100%; padding:12px; margin-bottom:20px; border-radius:8px; border:1px solid #ddd;">
            <button onclick="handleLogin()" style="width:100%; padding:14px; background:var(--p-green); color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">SIGN IN</button>
            <p style="margin-top:15px; font-size:12px;">Don't have an account? <a href="#" onclick="toggleAuth()" style="color:var(--a-gold)">Request Access</a></p>
        </div>
        
        <div class="auth-card" id="register-form" style="display:none;">
            <h2>Apply for Access</h2>
            <input type="text" id="r-user" placeholder="Full Name" style="width:100%; padding:12px; margin-bottom:15px; border-radius:8px;">
            <input type="email" id="r-email" placeholder="Professional Email" style="width:100%; padding:12px; margin-bottom:15px; border-radius:8px;">
            <input type="password" id="r-pass" placeholder="Password" style="width:100%; padding:12px; margin-bottom:20px; border-radius:8px;">
            <button onclick="handleRegister()" style="width:100%; padding:14px; background:var(--p-green); color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">SUBMIT APPLICATION</button>
            <p style="margin-top:15px;"><a href="#" onclick="toggleAuth()" style="color:var(--a-gold)">Back to Login</a></p>
        </div>
    </div>

    <div id="chat-screen" style="display:none; flex-direction:column; height:100vh;">
        <div class="top-nav">
            <div style="font-weight:900; letter-spacing:1px; font-size:18px;">CIVILITY CHAT <span id="room-title" style="color:var(--a-gold); font-weight:300;">| General</span></div>
            <div class="user-status-strip">
                <span id="display-name" style="font-weight:bold; font-size:14px;"></span>
                <img id="my-avatar" class="mini-avatar">
                <button onclick="logout()" style="background:none; border:1px solid rgba(255,255,255,0.3); color:white; padding:5px 15px; border-radius:20px; font-size:11px; cursor:pointer;">LOGOUT</button>
            </div>
        </div>

        <div class="rooms-bar">
            <button class="room-btn active" onclick="switchRoom('General')">‚òï General Lounge</button>
            <button class="room-btn" onclick="switchRoom('VIP Boardroom')">üíé VIP Boardroom</button>
            <button class="room-btn" onclick="switchRoom('Announcements')">üì¢ News Feed</button>
        </div>

        <div id="main-container">
            <div id="chat-section">
                <div id="chat-box"></div>
                <div class="chat-input-area">
                    <input type="text" id="msg-input" placeholder="Share your thoughts...">
                    <button onclick="sendMsg()" style="background:var(--p-green); color:white; border:none; padding:12px 25px; border-radius:30px; font-weight:bold; cursor:pointer;">SEND</button>
                </div>
                
                <div id="admin-panel">
                    <span style="color:var(--admin-red); font-weight:bold; font-size:12px; width:100%;">ADMIN COMMAND CENTER:</span>
                    <input type="text" id="mod-target" placeholder="User Email" style="padding:5px; border-radius:5px; border:1px solid #ddd;">
                    <button onclick="adminAction('ban')" style="background:var(--admin-red); color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">BAN</button>
                    <button onclick="adminAction('unban')" style="background:#2ecc71; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">UNBAN</button>
                    <button onclick="adminAction('vip')" style="background:var(--vip-blue); color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">GRANT VIP</button>
                </div>
            </div>

            <div id="profile-sidebar">
                <div class="online-tag">‚óè MEMBERS ONLINE</div>
                <div id="online-list" style="overflow-y:auto; flex:1;"></div>
                <hr style="width:100%; border:0; border-top:1px solid #eee; margin:20px 0;">
                <div style="font-size:12px; color:#999; text-align:center;">Elite Member Support Available 24/7</div>
            </div>
        </div>
    </div>

    <script>
        let userEmail = '', username = '', isAdmin = false, isVIP = false, userAvatar = '';
        let currentRoom = 'General';

        async function handleLogin() {
            const email = document.getElementById('l-email').value;
            const password = document.getElementById('l-pass').value;
            const res = await fetch('/api/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ email, password })
            });
            if (res.ok) {
                const data = await res.json();
                userEmail = data.email; username = data.username; isAdmin = data.isAdmin; isVIP = data.isVIP; userAvatar = data.avatar;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('chat-screen').style.display = 'flex';
                document.getElementById('display-name').innerText = username.toUpperCase();
                document.getElementById('my-avatar').src = userAvatar;
                if (isAdmin) document.getElementById('admin-panel').style.display = 'flex';
                loadMessages(true);
                updateOnlineList();
            } else { alert("Verification failed. Please check credentials."); }
        }

        async function handleRegister() {
            const user = document.getElementById('r-user').value;
            const email = document.getElementById('r-email').value;
            const pass = document.getElementById('r-pass').value;
            const res = await fetch('/api/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username: user, email, password: pass })
            });
            if (res.ok) { alert("Application submitted. You may now login."); toggleAuth(); }
        }

        function toggleAuth() {
            const login = document.getElementById('login-form');
            const reg = document.getElementById('register-form');
            login.style.display = login.style.display === 'none' ? 'block' : 'none';
            reg.style.display = reg.style.display === 'none' ? 'block' : 'none';
        }

        // 3. ADDED: Fixed Online List function
        async function updateOnlineList() {
            try {
                const res = await fetch('/api/online-users');
                const users = await res.json();
                const list = document.getElementById('online-list');
                list.innerHTML = '';
                users.forEach(u => {
                    const div = document.createElement('div');
                    div.style.display = 'flex'; div.style.alignItems = 'center'; div.style.gap = '10px'; div.style.marginBottom = '12px';
                    div.innerHTML = `<img src="${u.avatar}" style="width:25px; height:25px; border-radius:50%; border:1px solid var(--a-gold);">
                                     <span style="font-size:13px; font-weight:500;">${u.username}</span>`;
                    list.appendChild(div);
                });
            } catch (e) { console.log("List error", e); }
        }

        // 4. ADDED: Delete Message function
        async function deleteMsg(id) {
            if (!confirm("Remove this entry from the archive?")) return;
            const res = await fetch(`/api/messages/${id}?adminEmail=${userEmail}`, { method: 'DELETE' });
            if (res.ok) document.getElementById(`msg-${id}`).remove();
        }

        async function loadMessages(forceClear = false) {
            const res = await fetch(`/api/messages?room=${currentRoom}&userEmail=${userEmail}`);
            const messages = await res.json();
            const box = document.getElementById('chat-box');
            if (forceClear) box.innerHTML = '';
            let addedNew = false;
            messages.forEach(m => {
                if (!document.getElementById(`msg-${m._id}`)) {
                    const div = document.createElement('div');
                    div.id = `msg-${m._id}`;
                    div.className = 'message';
                    div.style.alignSelf = m.email === userEmail ? 'flex-end' : 'flex-start';
                    if(m.email === userEmail) div.style.background = '#e1f5fe';
                    
                    // 5. UPDATED: Show Delete button only for admins
                    const deleteBtn = isAdmin ? `<button onclick="deleteMsg('${m._id}')" style="color:var(--admin-red); background:none; border:none; cursor:pointer; font-size:10px; margin-left:10px; font-weight:bold;">[DELETE]</button>` : '';
                    
                    const img = m.imageUrl ? `<img src="${m.imageUrl}" style="max-width:100%; border-radius:10px; margin-top:10px;">` : '';
                    div.innerHTML = `<div class="msg-header">
                                        <strong>${m.username}</strong> 
                                        ${m.isAdmin?'<span style="color:red; font-size:9px">[ADMIN]</span>':''}
                                        ${deleteBtn}
                                     </div>
                                     <div style="font-size:14px;">${m.text}</div>${img}`;
                    box.appendChild(div);
                    addedNew = true;
                }
            });
            if (addedNew) box.scrollTop = box.scrollHeight;
        }

        async function sendMsg() {
            const input = document.getElementById('msg-input');
            const text = input.value;
            if (!text) return;
            await fetch('/api/messages', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ email: userEmail, username, text, room: currentRoom, avatar: userAvatar })
            });
            input.value = '';
            loadMessages();
        }

        function switchRoom(room) {
            currentRoom = room;
            document.getElementById('room-title').innerText = `| ${room}`;
            document.querySelectorAll('.room-btn').forEach(btn => btn.classList.toggle('active', btn.innerText.includes(room)));
            loadMessages(true);
        }

        async function adminAction(action) {
            const target = document.getElementById('mod-target').value;
            await fetch('/api/admin/action', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ adminEmail: userEmail, targetEmail: target, action }) });
            alert("Administrative action confirmed.");
        }

        function logout() { localStorage.clear(); location.reload(); }
        setInterval(() => loadMessages(false), 4000);
        setInterval(updateOnlineList, 10000);
    </script>
</body>
</html>