<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elite Chat | Emerald Park</title>
    <style>
        :root { --p-green: #1B3022; --a-gold: #D4AF37; --bg: #FDFBF7; --admin-red: #e74c3c; --vip-blue: #3498db; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        @media (max-width: 768px) { #profile-sidebar { display: none; } .header { padding: 10px; } .logo-row { margin: 10px 0; transform: scale(0.8); } }
        .logo-row { display: flex; justify-content: center; align-items: center; gap: 15px; margin: 20px 0; }
        .logo-s { width: 45px; height: 45px; background: var(--p-green); border: 2px solid var(--a-gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; color: var(--a-gold); }
        .logo-l { width: 85px; height: 85px; background: var(--p-green); border: 4px solid var(--a-gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 42px; color: var(--a-gold); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .header { background: var(--p-green); color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--a-gold); z-index: 10; }
        .rooms-bar { background: #264230; padding: 10px; display: flex; gap: 10px; overflow-x: auto; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .room-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 8px 18px; border-radius: 25px; cursor: pointer; transition: 0.3s; white-space: nowrap; }
        .room-btn.active { background: var(--a-gold); color: var(--p-green); font-weight: bold; transform: scale(1.05); }
        #main-container { display: flex; flex: 1; overflow: hidden; }
        #chat-section { flex: 1; display: flex; flex-direction: column; position: relative; }
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; background: var(--bg); display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; }
        .message { background: white; padding: 12px; border-radius: 12px; border-left: 5px solid var(--p-green); box-shadow: 0 3px 8px rgba(0,0,0,0.05); max-width: 85%; animation: slideIn 0.3s ease; position: relative; cursor: pointer; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .msg-header { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
        .badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; color: white; font-weight: bold; text-transform: uppercase; }
        .badge-admin { background: var(--admin-red); }
        .badge-vip { background: var(--vip-blue); }
        .badge-dm { background: #9b59b6; }
        .msg-img { max-width: 100%; border-radius: 10px; margin-top: 10px; }
        .del-btn { color: var(--admin-red); cursor: pointer; font-size: 11px; float: right; font-weight: bold; opacity: 0.7; }
        #profile-sidebar { width: 260px; background: white; border-left: 1px solid #ddd; display: flex; flex-direction: column; padding: 20px; box-shadow: -5px 0 15px rgba(0,0,0,0.02); overflow-y: auto; }
        .sidebar-avatar { width: 100px; height: 100px; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; background: #eee; overflow: hidden; cursor: pointer; }
        .sidebar-avatar img { width: 100%; height: 100%; object-fit: cover; }
        #mod-panel { display: none; background: #fff1f1; border: 1px solid #ffcccc; padding: 10px; border-radius: 10px; margin-top: 15px; }
        .mod-btn { font-size: 10px; padding: 5px; margin: 2px; border: none; border-radius: 4px; color: white; cursor: pointer; }
        #auth-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #e9ecef 0%, #cbd3da 100%); }
        .auth-card { background: white; padding: 30px; border-radius: 20px; width: 320px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 14px; }
        .btn-p { width: 100%; padding: 14px; background: var(--p-green); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; }
        #chat-screen { display: none; flex-direction: column; height: 100vh; }
    </style>
    <style>
    /* ... all your existing CSS ... */

    /* --- MOBILE OPTIMIZATIONS --- */
    @media (max-width: 768px) {
        #profile-sidebar { display: none !important; }
        #main-container { flex-direction: column; }
        .message { max-width: 95% !important; }
        .rooms-bar { justify-content: flex-start; }
        #msg-input { font-size: 16px; } /* Stops iPhone zoom */
    }
</style>
</head>
<body>
    <div id="auth-screen">
        <div class="logo-row"><div class="logo-s">üí¨</div><div class="logo-l">üí¨</div><div class="logo-s">üí¨</div></div>
        <div class="auth-card">
            <h2 style="text-align:center; color: var(--p-green);">Welcome Back</h2>
            <input type="email" id="l-email" placeholder="Email">
            <input type="password" id="l-pass" placeholder="Password">
            <button class="btn-p" onclick="handleLogin()">ENTER CHAT</button>
        </div>
        <div class="auth-card">
            <h3 style="margin-top:0;">Join the Elite</h3>
            <input type="text" id="r-user" placeholder="Username">
            <input type="email" id="r-email" placeholder="Email">
            <input type="password" id="r-pass" placeholder="Password">
            <button class="btn-p" onclick="handleRegister()">CREATE ACCOUNT</button>
        </div>
    </div>

    <div id="chat-screen">
        <div class="header">
            <div><strong>ELITE CHAT üí¨</strong> <span id="room-title" style="margin-left:15px; font-weight:normal; opacity:0.8;">| General</span></div>
            <button onclick="logout()" style="background:none; border:1px solid white; color:white; border-radius:5px; cursor:pointer;">Exit</button>
        </div>
        <div class="rooms-bar">
            <button class="room-btn active" onclick="switchRoom('General')">Main Lobby</button>
            <button class="room-btn" onclick="switchRoom('Dating site')">Garden Terrace ‚ù§Ô∏è</button>
            <button class="room-btn" onclick="switchRoom('DM')">Private DMs üì©</button>
            <button class="room-btn" onclick="switchRoom('Gaming')">Arcade Room</button>
            <button class="room-btn" onclick="switchRoom('VIP Lounge')">VIP Lounge üíé</button>
        </div>

        <div id="main-container">
            <div id="chat-section">
                <div id="chat-box"></div>
                <div style="background:white; padding:20px; display:flex; gap:12px; border-top:1px solid #ddd; align-items:center;">
                    <input type="file" id="msg-file" style="display:none;" onchange="uploadAndSend()">
                    <button onclick="document.getElementById('msg-file').click()" style="background:none; border:none; font-size:24px; cursor:pointer;">üì∑</button>
                    <input type="text" id="msg-input" placeholder="Compose a message..." style="flex:1; margin:0;">
                    <button onclick="sendMsg()" class="btn-p" style="width:100px;">SEND</button>
                </div>
            </div>

            <div id="profile-sidebar">
                <input type="file" id="pfp-input" style="display:none;" onchange="updateProfilePic()">
                <div class="sidebar-avatar" id="side-avatar" onclick="document.getElementById('pfp-input').click()">üë§</div>
                <h3 id="side-username" style="text-align:center; margin:0;">Username</h3>
                <p id="side-status" style="text-align:center; color: #2ecc71; font-size: 12px; font-weight:bold;">‚óè Online</p>
                <hr style="width:100%; margin:20px 0; border:0; border-top:1px solid #eee;">
                <label style="font-size:11px; color:#888;">MY BIOGRAPHY</label>
                <textarea id="my-bio" placeholder="About me..."></textarea>
                <button onclick="updateProfile()" class="btn-p" style="padding:8px; font-size:12px; background:var(--a-gold); color:var(--p-green);">Save Profile</button>
                
                <div id="mod-panel">
                    <label style="font-size:11px; color:var(--admin-red); font-weight:bold;">ADMIN MODERATION</label>
                    <input type="text" id="mod-target" placeholder="User Email" style="font-size:10px; padding:5px;">
                    <button class="mod-btn" style="background:var(--admin-red)" onclick="adminAction('ban')">BAN</button>
                    <button class="mod-btn" style="background:var(--admin-red)" onclick="adminAction('mute')">MUTE</button>
                    <button class="mod-btn" style="background:#2ecc71" onclick="adminAction('unmute')">UNMUTE</button>
                    <button class="mod-btn" style="background:var(--vip-blue)" onclick="adminAction('makeVIP')">VIP</button>
                </div>

                <hr style="width:100%; margin:20px 0; border:0; border-top:1px solid #eee;">
                <label style="font-size:11px; color:#888; font-weight:bold;">UPGRADE STATUS</label>
                <button onclick="requestSupport('VIP Pass')" class="btn-p" style="font-size:11px; padding:8px; background:var(--vip-blue); margin-top:5px;">Request VIP üíé</button>
                <button onclick="requestSupport('Founder Tier')" class="btn-p" style="font-size:11px; padding:8px; background:var(--admin-red); margin-top:5px;">Request Founder üëë</button>
            </div>
        </div>
    </div>

    <script>
        let userEmail = localStorage.getItem('userEmail'), username = localStorage.getItem('username'), isAdmin = false, currentRoom = 'General', currentAvatar = 'üë§';
        if (userEmail) enterChat();

        function enterChat() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('chat-screen').style.display = 'flex';
            checkStatus();
        }

        async function handleLogin() {
            const res = await fetch('/api/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ email: document.getElementById('l-email').value, password: document.getElementById('l-pass').value })
            });
            if(res.ok) {
                const data = await res.json();
                localStorage.setItem('userEmail', data.email);
                localStorage.setItem('username', data.username);
                location.reload();
            } else alert("Access Denied");
        }

        async function handleRegister() {
            await fetch('/api/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username: document.getElementById('r-user').value, email: document.getElementById('r-email').value, password: document.getElementById('r-pass').value })
            });
            alert("Success! Now please login.");
        }

        async function checkStatus() {
            const res = await fetch(`/api/user-status?email=${userEmail}`);
            const data = await res.json();
            isAdmin = data.isAdmin;
            currentAvatar = data.avatar;
            document.getElementById('side-avatar').innerHTML = currentAvatar.includes('/') ? `<img src="${currentAvatar}">` : currentAvatar;
            document.getElementById('side-username').innerText = username;
            document.getElementById('my-bio').value = data.bio || "";
            if(isAdmin) document.getElementById('mod-panel').style.display = 'block';
            loadMessages(true);
        }

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            const res = await fetch('/api/upload', { method: 'POST', body: formData });
            const data = await res.json();
            return data.url;
        }

        async function updateProfilePic() {
            const file = document.getElementById('pfp-input').files[0];
            if(!file) return;
            const url = await uploadFile(file);
            currentAvatar = url;
            document.getElementById('side-avatar').innerHTML = `<img src="${url}">`;
            updateProfile();
        }

        async function updateProfile() {
            await fetch('/api/update-profile', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ email: userEmail, bio: document.getElementById('my-bio').value, avatar: currentAvatar })
            });
        }

        async function uploadAndSend() {
            const file = document.getElementById('msg-file').files[0];
            if(!file) return;
            const url = await uploadFile(file);
            await fetch('/api/messages', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ email: userEmail, text: "Shared a photo", imageUrl: url, room: currentRoom })
            });
            loadMessages();
        }

        async function loadMessages(forceClear = false) {
            const res = await fetch(`/api/messages?room=${currentRoom}&userEmail=${userEmail}`);
            const messages = await res.json();
            const box = document.getElementById('chat-box');
            if (forceClear) box.innerHTML = '';
            let addedNew = false;
            messages.forEach(m => {
                if (!document.getElementById(`msg-${m._id}`)) {
                    const div = document.createElement('div');
                    div.id = `msg-${m._id}`;
                    div.className = 'message';
                    div.onclick = () => startDM(m.email, m.username);
                    const pfp = m.avatar.includes('/') ? `<img src="${m.avatar}" style="width:30px;height:30px;border-radius:50%;object-fit:cover;">` : `<span style="font-size:20px;">${m.avatar}</span>`;
                    const img = m.imageUrl ? `<img src="${m.imageUrl}" class="msg-img">` : '';
                    div.innerHTML = `<div class="msg-header">${pfp} <strong>${m.username}</strong> ${m.isAdmin?'<span class="badge badge-admin">Founder</span>':''} ${m.isVIP?'<span class="badge badge-vip">VIP</span>':''} ${m.room==='DM'?'<span class="badge badge-dm">PRIVATE</span>':''} ${isAdmin?`<span class="del-btn" onclick="deleteMsg('${m._id}')">[Purge]</span>`:''}</div><div style="color:#444;">${m.text}</div>${img}<div style="font-size:9px; color:#aaa; margin-top:5px; text-align:right;">${new Date(m.timestamp).toLocaleTimeString()}</div>`;
                    box.appendChild(div);
                    addedNew = true;
                }
            });
            if (addedNew) box.scrollTop = box.scrollHeight;
        }

        function startDM(email, name) {
            if(email === userEmail) return;
            if(confirm(`Send private message to ${name}?`)) {
                const text = prompt("Message:");
                if(text) fetch('/api/messages', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ email: userEmail, text, room: 'DM', recipientEmail: email }) });
            }
        }

        async function adminAction(action) {
            const target = document.getElementById('mod-target').value;
            await fetch('/api/admin/action', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ adminEmail: userEmail, targetEmail: target, action }) });
            alert("Action done!");
        }

        async function requestSupport(tier) {
            await fetch('/api/support', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ email: userEmail, username: username, tier }) });
            alert("Request logged!");
        }

        async function sendMsg() {
            const input = document.getElementById('msg-input');
            if(!input.value) return;
            const res = await fetch('/api/messages', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ email: userEmail, text: input.value, room: currentRoom }) });
            if (res.status === 402) alert("VIP Required");
            input.value = '';
            loadMessages();
        }

        async function deleteMsg(id) {
            if(!confirm("Purge?")) return;
            const res = await fetch(`/api/messages/${id}?adminEmail=${userEmail}`, { method: 'DELETE' });
            if(res.ok) document.getElementById(`msg-${id}`)?.remove();
        }

        function switchRoom(room) {
            currentRoom = room;
            document.getElementById('room-title').innerText = `| ${room}`;
            document.querySelectorAll('.room-btn').forEach(btn => btn.classList.toggle('active', btn.innerText.includes(room.split(' ')[0])));
            loadMessages(true);
        }

        function logout() { localStorage.clear(); location.reload(); }
        setInterval(() => loadMessages(false), 4000);
    </script>
</body>
</html>