<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Civility Chat</title>
    <style>
        :root {
            --primary-green: #1B3022;
            --accent-gold: #D4AF37;
            --soft-cream: #FDFBF7;
            --text-dark: #2C2C2C;
        }

        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; display: flex; flex-direction: column; height: 100vh; color: var(--text-dark); }
        
        /* Logo Styling */
        .logo-container { text-align: center; margin-bottom: 20px; }
        .logo-circle { 
            width: 80px; height: 80px; background: var(--primary-green); 
            border: 3px solid var(--accent-gold); border-radius: 50%; 
            display: inline-flex; align-items: center; justify-content: center;
            font-size: 40px; color: var(--accent-gold); box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .brand-name { font-size: 24px; font-weight: bold; color: var(--primary-green); margin-top: 10px; letter-spacing: 1px; }
        .est-text { font-size: 10px; color: #888; text-transform: uppercase; margin-top: -5px; }

        .header { background: var(--primary-green); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--accent-gold); }
        .rooms-bar { background: #264230; color: white; padding: 10px; display: flex; gap: 10px; overflow-x: auto; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .room-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 8px 18px; border-radius: 20px; cursor: pointer; transition: 0.3s; }
        .room-btn.active { background: var(--accent-gold); color: white; font-weight: bold; }
        
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; background: var(--soft-cream); }
        .message { background: white; padding: 12px; border-radius: 12px; max-width: 80%; display: flex; align-items: flex-start; gap: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 4px solid var(--primary-green); }
        .avatar-circle { font-size: 24px; background: #eee; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .del-btn { color: #d9534f; cursor: pointer; font-size: 11px; margin-left: 10px; font-weight: bold; text-decoration: none; }
        
        #auth-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background: #e9ecef; padding: 20px; }
        .auth-container { background: white; padding: 25px; border-radius: 15px; width: 100%; max-width: 350px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin: 8px 0; box-sizing: border-box; }
        button.primary-btn { width: 100%; padding: 12px; background: var(--primary-green); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        #chat-screen { display: none; flex-direction: column; height: 100vh; }
    </style>
</head>
<body>
    <div id="auth-screen">
        <div class="logo-container">
            <div class="logo-circle">â˜•</div>
            <div class="brand-name">CIVILITY CHAT</div>
            <div class="est-text">Established 2025</div>
        </div>
        <div class="auth-container">
            <h3 style="margin-top:0">Welcome Back</h3>
            <input type="email" id="login-email" placeholder="Email">
            <input type="password" id="login-pass" placeholder="Password">
            <button class="primary-btn" onclick="handleLogin()">SIGN IN</button>
        </div>
        <div class="auth-container" style="background: #f8f9fa;">
            <h3 style="margin-top:0">New Member</h3>
            <input type="text" id="reg-user" placeholder="Username">
            <input type="email" id="reg-email" placeholder="Email">
            <input type="password" id="reg-pass" placeholder="Password">
            <select id="reg-avatar">
                <option value="ðŸ‘¤">Standard</option><option value="ðŸ‘‘">VIP</option>
            </select>
            <button class="primary-btn" style="background:#4a6741" onclick="handleRegister()">REGISTER</button>
        </div>
    </div>

    <div id="chat-screen">
        <div class="header">
            <span style="font-weight:bold; letter-spacing:1px;">CIVILITY CHAT</span>
            <button onclick="logout()" style="background:#c0392b; color:white; border:none; padding:5px 12px; border-radius:5px; cursor:pointer;">LOGOUT</button>
        </div>
        <div class="rooms-bar">
            <button class="room-btn active" onclick="switchRoom('Dating site')">Dating Room</button>
            <button class="room-btn" onclick="switchRoom('Support Account')">â˜• Support</button>
        </div>
        <div id="chat-box"></div>
        <div style="background:white; padding:15px; display:flex; gap:10px; border-top:1px solid #ddd;">
            <input type="text" id="msg-input" placeholder="Message..." style="margin:0;">
            <button onclick="sendMsg()" style="background:var(--primary-green); color:white; border:none; padding:0 20px; border-radius:8px; cursor:pointer;">Send</button>
        </div>
    </div>

    <script>
        let userEmail = localStorage.getItem('userEmail');
        let username = localStorage.getItem('username');
        let isAdmin = false;
        let currentRoom = 'Dating site';

        if (userEmail) enterChat();

        function enterChat() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('chat-screen').style.display = 'flex';
            checkStatus();
        }

        async function handleLogin() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-pass').value;
            const res = await fetch('/api/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ email, password })
            });
            if(res.ok) {
                const user = await res.json();
                localStorage.setItem('userEmail', user.email);
                localStorage.setItem('username', user.username);
                userEmail = user.email;
                username = user.username;
                enterChat();
            } else alert("Invalid credentials.");
        }

        async function handleRegister() {
            const usernameInput = document.getElementById('reg-user').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-pass').value;
            const avatar = document.getElementById('reg-avatar').value;
            const res = await fetch('/api/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username: usernameInput, email, password, avatar })
            });
            if(res.ok) alert("Registered!");
            else alert("Error during registration.");
        }

        async function checkStatus() {
            const res = await fetch(`/api/user-status?email=${userEmail}`);
            const data = await res.json();
            isAdmin = data.isAdmin;
            loadMessages();
        }

        async function loadMessages() {
            const res = await fetch('/api/messages');
            const messages = await res.json();
            const box = document.getElementById('chat-box');
            box.innerHTML = '';
            messages.filter(m => m.room === currentRoom || (!m.room && currentRoom === 'Dating site')).forEach(m => {
                const div = document.createElement('div');
                div.className = 'message';
                const deleteLink = isAdmin ? `<a href="#" class="del-btn" onclick="deleteMsg('${m._id}')">[Delete]</a>` : '';
                div.innerHTML = `<div class="avatar-circle">${m.avatar || 'ðŸ‘¤'}</div> <div><strong style="color:var(--primary-green)">${m.username}</strong>: ${m.text}${deleteLink}</div>`;
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
        }

        async function deleteMsg(id) {
            if(!confirm("Delete this?")) return;
            const res = await fetch(`/api/messages/${id}?adminEmail=${userEmail}`, { method: 'DELETE' });
            if(res.ok) loadMessages();
        }

        async function sendMsg() {
            const text = document.getElementById('msg-input').value.trim();
            if(!text) return;
            await fetch('/api/messages', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ email: userEmail, username, text, room: currentRoom })
            });
            document.getElementById('msg-input').value = '';
            loadMessages();
        }

        function switchRoom(room) {
            currentRoom = room;
            document.querySelectorAll('.room-btn').forEach(btn => btn.classList.toggle('active', btn.innerText.includes(room)));
            loadMessages();
        }

        function logout() { localStorage.clear(); location.reload(); }
        setInterval(loadMessages, 3000);
    </script>
</body>
</html>