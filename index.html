<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Civility Portal | The Professional English Chat</title>
    <style>
        :root { --p-blue: #0084ff; --p-bg: #f0f2f5; --p-border: #dddfe2; --p-text: #1c1e21; --p-gray: #65676b; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { background: var(--p-bg); height: 100vh; display: flex; flex-direction: column; color: var(--p-text); }

        /* AZET-STYLE TOP NAV */
        .azet-bar { background: #1a1a1a; color: #ccc; font-size: 11px; padding: 7px 25px; display: flex; justify-content: space-between; font-weight: bold; }
        .azet-bar span { cursor: pointer; transition: 0.2s; }
        .azet-bar span:hover { color: #fff; }

        /* MAIN HEADER */
        header { background: #fff; border-bottom: 1px solid var(--p-border); padding: 12px 25px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .logo { color: var(--p-blue); font-size: 28px; font-weight: 800; letter-spacing: -1px; text-decoration: none; }
        .search-container { background: #f0f2f5; border-radius: 20px; padding: 8px 15px; width: 300px; display: flex; align-items: center; }
        .search-container input { background: transparent; border: none; outline: none; width: 100%; font-size: 14px; }

        /* LAYOUT GRID */
        #portal-grid { display: grid; grid-template-columns: 260px 1fr 300px; flex: 1; overflow: hidden; }

        /* LEFT SIDEBAR: NAVIGATION */
        .nav-sidebar { background: #fff; border-right: 1px solid var(--p-border); padding: 20px 10px; overflow-y: auto; }
        .nav-group { margin-bottom: 25px; }
        .nav-label { font-size: 12px; font-weight: 700; color: var(--p-gray); padding: 0 15px 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 12px 15px; border-radius: 10px; cursor: pointer; transition: 0.2s; font-weight: 500; font-size: 15px; }
        .nav-link:hover { background: #f2f2f2; }
        .nav-link.active { background: #e7f3ff; color: var(--p-blue); }
        .nav-icon { width: 32px; height: 32px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; }

        /* MAIN CHAT AREA */
        .chat-view { background: #fff; display: flex; flex-direction: column; }
        .room-status { padding: 15px 25px; border-bottom: 1px solid var(--p-border); display: flex; justify-content: space-between; align-items: center; }
        #chat-scroller { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; background: white; }

        /* MESSAGE DESIGN */
        .msg-post { display: flex; gap: 15px; padding-bottom: 15px; border-bottom: 1px solid #f8f8f8; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
        .u-avatar { width: 50px; height: 50px; border-radius: 12px; border: 1px solid #eee; }
        .msg-body { flex: 1; }
        .msg-meta { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .u-nick { font-weight: 700; color: var(--p-blue); font-size: 14px; cursor: pointer; }
        .m-time { font-size: 11px; color: var(--p-gray); }
        .m-text { font-size: 14px; line-height: 1.5; color: #1c1e21; }

        /* INPUT BAR */
        .input-panel { padding: 20px; border-top: 1px solid var(--p-border); }
        .input-box { background: #f0f2f5; border-radius: 25px; display: flex; align-items: center; padding: 5px 20px; border: 1px solid var(--p-border); }
        #main-input { flex: 1; border: none; background: transparent; padding: 12px 0; outline: none; font-size: 15px; }
        .send-trigger { background: var(--p-blue); color: #fff; border: none; padding: 8px 25px; border-radius: 20px; font-weight: bold; cursor: pointer; margin-left: 10px; }

        /* RIGHT SIDEBAR: USERS */
        .user-sidebar { background: #fff; border-left: 1px solid var(--p-border); padding: 20px; overflow-y: auto; }
        .u-card { display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: 8px; cursor: pointer; position: relative; }
        .u-card:hover { background: #f9f9f9; }
        .online-led { width: 10px; height: 10px; background: #42b72a; border-radius: 50%; border: 2px solid #fff; position: absolute; bottom: 10px; left: 45px; }

        /* AUTH GATE */
        #auth-overlay { position: fixed; inset: 0; background: var(--p-bg); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .auth-card { background: #fff; padding: 45px; border-radius: 15px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); width: 420px; text-align: center; }
        .auth-card h2 { font-size: 32px; color: var(--p-blue); margin-bottom: 30px; }
        .auth-card input { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid var(--p-border); border-radius: 8px; font-size: 16px; }
        
        .btn-full { width: 100%; padding: 15px; background: var(--p-blue); color: #fff; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-logout { font-size: 12px; background: none; border: 1px solid #ccc; padding: 5px 10px; border-radius: 5px; cursor: pointer; color: #666; }
    </style>
</head>
<body>

<div id="auth-overlay">
    <div class="auth-card">
        <h2>Civility Portal</h2>
        <input type="text" id="reg-nick" placeholder="Nickname">
        <input type="email" id="reg-email" placeholder="Email Address">
        <input type="password" id="reg-pass" placeholder="Password">
        <button onclick="runAuth()" class="btn-full">Sign Up & Enter</button>
        <p style="margin-top: 15px; font-size: 12px; color: #888;">Professional English Community</p>
    </div>
</div>

<div class="azet-bar">
    <div>SERVICES | PORTAL | CHAT | VIDEO | NEWS | MAPS</div>
    <div id="user-header-info">Not Logged In</div>
</div>

<header>
    <a href="/" class="logo">Civility</a>
    <div class="search-container">
        <input type="text" placeholder="Search people, rooms, or news...">
    </div>
    <div style="display:flex; gap:15px; align-items:center;">
        <span id="my-name" style="font-weight:bold;"></span>
        <button class="btn-logout" onclick="logout()">Logout</button>
    </div>
</header>

<div id="portal-grid">
    <aside class="nav-sidebar">
        <div class="nav-group">
            <div class="nav-label">Community Hub</div>
            <div class="nav-link active" onclick="setChannel('Lounge')"><div class="nav-icon">â˜•</div> General Lounge</div>
            <div class="nav-link" onclick="setChannel('International')"><div class="nav-icon">ðŸŒŽ</div> International</div>
            <div class="nav-link" onclick="setChannel('Tech')"><div class="nav-icon">ðŸ’»</div> Technology</div>
        </div>
        <div class="nav-group">
            <div class="nav-label">Members Only</div>
            <div class="nav-link" onclick="setChannel('VIP')"><div class="nav-icon">ðŸ’Ž</div> VIP Member Club</div>
            <div class="nav-link" onclick="alert('Profiles Coming Soon')"><div class="nav-icon">ðŸ‘¤</div> My Profile</div>
        </div>
    </aside>

    <main class="chat-view">
        <div class="room-status">
            <div>
                <h2 id="room-display">General Lounge</h2>
                <small style="color:var(--p-gray)">English-only professional discussion</small>
            </div>
            <div style="text-align:right">
                <span style="font-size:12px; color:var(--p-gray)">Room ID: #001</span>
            </div>
        </div>

        <div id="chat-scroller"></div>

        <div class="input-panel">
            <div class="input-wrapper">
                <div class="input-box">
                    <input type="text" id="main-input" placeholder="Write something cool..." onkeypress="if(event.key==='Enter') pushMsg()">
                    <button class="send-trigger" onclick="pushMsg()">Send</button>
                </div>
            </div>
        </div>
    </main>

    <aside class="user-sidebar">
        <div class="nav-label">Online Users</div>
        <div id="online-users"></div>
    </aside>
</div>

<script>
    let room = 'Lounge';
    let me = JSON.parse(localStorage.getItem('user'));

    if(me) {
        document.getElementById('auth-overlay').style.display = 'none';
        document.getElementById('my-name').innerText = me.username;
        document.getElementById('user-header-info').innerText = "Account: " + me.username;
    }

    async function runAuth() {
        const u = document.getElementById('reg-nick').value;
        const e = document.getElementById('reg-email').value;
        const p = document.getElementById('reg-pass').value;

        const res = await fetch('/api/auth/register', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username: u, email: e, password: p})
        });

        if(res.ok) {
            const data = await res.json();
            localStorage.setItem('user', JSON.stringify(data));
            location.reload();
        } else {
            alert("Username or email already in use.");
        }
    }

    function logout() {
        localStorage.removeItem('user');
        location.reload();
    }

    async function pushMsg() {
        const input = document.getElementById('main-input');
        if(!input.value) return;

        await fetch('/api/chat/send', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                username: me.username,
                text: input.value,
                room: room,
                userId: me._id
            })
        });
        input.value = '';
        sync();
    }

    async function sync() {
        const res = await fetch(`/api/chat/fetch?room=${room}`);
        const data = await res.json();
        const scroller = document.getElementById('chat-scroller');
        
        scroller.innerHTML = data.map(m => `
            <div class="msg-post">
                <img src="https://api.dicebear.com/7.x/identicon/svg?seed=${m.username}" class="u-avatar">
                <div class="msg-body">
                    <div class="msg-meta">
                        <span class="u-nick">${m.username}</span>
                        <span class="m-time">${new Date(m.timestamp).toLocaleTimeString()}</span>
                    </div>
                    <div class="m-text">${m.text}</div>
                </div>
            </div>
        `).join('');
        scroller.scrollTop = scroller.scrollHeight;

        // Fake Online List (Sync with database in next version)
        document.getElementById('online-users').innerHTML = `
            <div class="u-card">
                <img src="https://api.dicebear.com/7.x/identicon/svg?seed=${me.username}" width="40" height="40" style="border-radius:8px">
                <div><strong>${me.username}</strong><br><small>Active Now</small></div>
                <div class="online-led"></div>
            </div>
        `;
    }

    function setChannel(c) {
        room = c;
        document.getElementById('room-display').innerText = c + " Room";
        document.querySelectorAll('.nav-link').forEach(l => l.classList.toggle('active', l.innerText.includes(c)));
        sync();
    }

    setInterval(sync, 3000);
    if(me) sync();
</script>
</body>
</html>