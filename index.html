<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Civility | English Portal</title>
    <style>
        :root { --p-blue: #0084ff; --p-dark: #1c1e21; --bg: #f0f2f5; --border: #dddfe2; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
        body { background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* Top Admin Bar */
        #top-bar { background: #1a1a1a; color: #ccc; font-size: 11px; padding: 6px 20px; display: flex; justify-content: space-between; }
        
        /* Header */
        header { background: #fff; border-bottom: 1px solid var(--border); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        .logo { color: var(--p-blue); font-size: 26px; font-weight: 800; text-decoration: none; }
        
        /* Layout */
        #wrapper { display: grid; grid-template-columns: 240px 1fr 280px; flex: 1; overflow: hidden; }

        /* Sidebar Left: Channels */
        .s-left { background: #fff; border-right: 1px solid var(--border); padding: 15px; }
        .nav-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: 8px; cursor: pointer; color: #050505; font-weight: 500; margin-bottom: 2px; }
        .nav-item:hover { background: #f2f2f2; }
        .nav-item.active { background: #e7f3ff; color: var(--p-blue); }

        /* Chat Area */
        .chat-main { display: flex; flex-direction: column; background: #fff; }
        #msg-stream { flex: 1; overflow-y: auto; padding: 20px; border-bottom: 1px solid var(--border); }
        
        /* Messages */
        .post { display: flex; gap: 12px; margin-bottom: 15px; border-bottom: 1px solid #f5f5f5; padding-bottom: 10px; }
        .p-avatar { width: 45px; height: 45px; border-radius: 10px; background: #eee; }
        .p-user { font-weight: bold; color: var(--p-blue); font-size: 14px; }
        .p-time { color: #90949c; font-size: 11px; margin-left: 8px; }
        .p-text { font-size: 14px; color: #1c1e21; margin-top: 3px; }

        /* Input */
        .p-input { padding: 20px; display: flex; gap: 10px; align-items: center; }
        #m-input { flex: 1; background: #f0f2f5; border: 1px solid var(--border); padding: 12px 20px; border-radius: 25px; outline: none; }
        .btn-send { background: var(--p-blue); color: #fff; border: none; padding: 10px 25px; border-radius: 20px; font-weight: bold; cursor: pointer; }

        /* Sidebar Right: Online */
        .s-right { background: #fff; border-left: 1px solid var(--border); padding: 15px; }

        /* Auth Screen */
        #auth-gate { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .card { background: #fff; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 380px; text-align: center; }
        .card input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid var(--border); border-radius: 6px; }
        .btn-logout { background: #f0f2f5; color: #444; border: 1px solid #ddd; padding: 5px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; }
    </style>
</head>
<body>

<div id="auth-gate">
    <div class="card">
        <h1 style="color:var(--p-blue); font-size: 32px; margin-bottom: 5px;">Civility</h1>
        <p style="color:#666; margin-bottom: 25px;">English Portal Community</p>
        <input type="text" id="r-nick" placeholder="Choose a Nickname">
        <input type="email" id="r-email" placeholder="Email Address">
        <input type="password" id="r-pass" placeholder="Password">
        <button onclick="doRegister()" class="btn-send" style="width:100%">Register & Join</button>
    </div>
</div>

<div id="top-bar">
    <div>SERVICES | PORTAL | CHAT | VIDEO</div>
    <div id="top-user-info"></div>
</div>

<header>
    <a href="#" class="logo">Civility</a>
    <button class="btn-logout" onclick="doLogout()">Log Out</button>
</header>

<div id="wrapper">
    <aside class="s-left">
        <div style="font-size: 12px; color: #888; margin-bottom: 10px;">CHANNELS</div>
        <div class="nav-item active" onclick="setRoom('General')">‚òï General Lounge</div>
        <div class="nav-item" onclick="setRoom('International')">üåç International</div>
        <div class="nav-item" onclick="setRoom('Tech')">üíª Tech & Dev</div>
        <div class="nav-item" onclick="setRoom('VIP')">üíé VIP Member Club</div>
    </aside>

    <main class="chat-main">
        <div style="padding:15px 20px; border-bottom:1px solid var(--border)">
            <h2 id="room-title">General Lounge</h2>
        </div>
        <div id="msg-stream"></div>
        <div class="p-input">
            <input type="text" id="m-input" placeholder="Type a message..." onkeypress="if(event.key==='Enter') sendMsg()">
            <button class="btn-send" onclick="sendMsg()">Send</button>
        </div>
    </main>

    <aside class="s-right">
        <div style="font-size: 12px; color: #888; margin-bottom: 10px;">USERS IN CHANNEL</div>
        <div id="user-list"></div>
    </aside>
</div>

<script>
    let currentRoom = 'General';
    let user = JSON.parse(localStorage.getItem('user'));

    if(user) {
        document.getElementById('auth-gate').style.display = 'none';
        document.getElementById('top-user-info').innerText = "Logged in as: " + user.username;
    }

    async function doRegister() {
        const username = document.getElementById('r-nick').value;
        const email = document.getElementById('r-email').value;
        const password = document.getElementById('r-pass').value;

        const res = await fetch('/api/register', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username, email, password})
        });

        if(res.ok) {
            const data = await res.json();
            localStorage.setItem('user', JSON.stringify(data));
            location.reload();
        } else {
            alert("Registration failed. Nickname might be taken.");
        }
    }

    function doLogout() {
        localStorage.removeItem('user');
        location.reload();
    }

    async function sendMsg() {
        const input = document.getElementById('m-input');
        if(!input.value) return;
        await fetch('/api/messages', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                username: user.username, email: user.email, text: input.value, room: currentRoom
            })
        });
        input.value = '';
        fetchMsgs();
    }

    async function fetchMsgs() {
        const res = await fetch(`/api/messages?room=${currentRoom}`);
        const data = await res.json();
        const stream = document.getElementById('msg-stream');
        stream.innerHTML = data.map(m => `
            <div class="post">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${m.username}" class="p-avatar">
                <div class="p-content">
                    <span class="p-user">${m.username}</span>
                    <span class="p-time">${new Date(m.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                    <div class="p-text">${m.text}</div>
                </div>
            </div>
        `).join('');
        stream.scrollTop = stream.scrollHeight;
    }

    function setRoom(r) {
        currentRoom = r;
        document.getElementById('room-title').innerText = r + " Lounge";
        document.querySelectorAll('.nav-item').forEach(i => i.classList.toggle('active', i.innerText.includes(r)));
        fetchMsgs();
    }

    setInterval(fetchMsgs, 3000);
    if(user) fetchMsgs();
</script>
</body>
</html>